name: Upload Markdown Snapshot to Google Drive (Direct API)

on:
  workflow_dispatch:
  push:
    branches:
      - main

jobs:
  snapshot:
    runs-on: ubuntu-latest

    steps:
      # 1Ô∏è‚É£ Repository auschecken
      - name: Checkout Repository
        uses: actions/checkout@v4

      # 2Ô∏è‚É£ Markdown Snapshot generieren
      - name: Create Markdown Snapshot
        run: |
          SNAPSHOT="recipe-vault_FULLCODE_$(date +'%Y-%m-%d_%H-%M-%S').md"
          echo "# üì¶ Recipe Vault ‚Äì Full Source Snapshot" > "$SNAPSHOT"
          echo "" >> "$SNAPSHOT"
          echo "**Timestamp:** $(date)" >> "$SNAPSHOT"
          echo "**Repository:** $GITHUB_REPOSITORY" >> "$SNAPSHOT"
          echo "" >> "$SNAPSHOT"

          echo "## üìÅ Repository Structure" >> "$SNAPSHOT"
          tree -a -I ".git|node_modules" >> "$SNAPSHOT" || echo "(tree not available)" >> "$SNAPSHOT"
          echo "" >> "$SNAPSHOT"

          echo "## üß© Complete File Contents" >> "$SNAPSHOT"
          echo "" >> "$SNAPSHOT"

          while IFS= read -r -d '' file; do
            [ "$file" = "./$SNAPSHOT" ] && continue
            echo -e "\n\n### File: \`$file\`\n\`\`\`\n" >> "$SNAPSHOT"
            cat "$file" >> "$SNAPSHOT"
            echo -e "\n\`\`\`" >> "$SNAPSHOT"
          done < <(find . -type f -not -path "./.git/*" -not -path "./node_modules/*" -print0)

          echo "SNAPSHOT=$SNAPSHOT" >> $GITHUB_ENV

      # 3Ô∏è‚É£ Snapshot zu Google Drive hochladen
      - name: Upload Snapshot to Google Drive
        env:
          GDRIVE_JSON: ${{ secrets.GDRIVE_SERVICE_KEY }}
          FOLDER_ID: ${{ secrets.GDRIVE_BASE44_FOLDER_ID }}
        run: |
          echo "üì¶ Installing dependencies..."
          sudo apt-get update -y && sudo apt-get install -y jq curl google-cloud-cli

          echo "$GDRIVE_JSON" > /tmp/sa.json
          export GOOGLE_APPLICATION_CREDENTIALS="/tmp/sa.json"

          echo "üîê Authenticating via Google Cloud CLI..."
          gcloud auth activate-service-account --key-file=/tmp/sa.json

          echo "üîß Setting correct Drive API scopes..."
          gcloud auth application-default login --scopes="https://www.googleapis.com/auth/drive.file,https://www.googleapis.com/auth/drive"

          ACCESS_TOKEN=$(gcloud auth application-default print-access-token)

          if [ -z "$ACCESS_TOKEN" ]; then
            echo "‚ùå No access token received!"
            exit 1
          fi

          echo "üì§ Uploading file to Google Drive..."
          UPLOAD_RESULT=$(curl -s -X POST \
            -H "Authorization: Bearer $ACCESS_TOKEN" \
            -F "metadata={name : '$SNAPSHOT', parents : ['$FOLDER_ID']};type=application/json;charset=UTF-8" \
            -F "file=@$SNAPSHOT;type=text/markdown" \
            "https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart")

          FILE_ID=$(echo "$UPLOAD_RESULT" | jq -r '.id')
          if [ -z "$FILE_ID" ] || [ "$FILE_ID" = "null" ]; then
            echo "‚ùå Upload failed!"
            echo "$UPLOAD_RESULT"
            exit 1
          fi

          echo "‚úÖ Upload successful! File ID: $FILE_ID"

          echo "üåê Retrieving webViewLink..."
          FILE_INFO=$(curl -s -X GET \
            -H "Authorization: Bearer $ACCESS_TOKEN" \
            "https://www.googleapis.com/drive/v3/files/$FILE_ID?fields=webViewLink,name")

          WEBLINK=$(echo "$FILE_INFO" | jq -r '.webViewLink')

          echo "‚úÖ Upload finished!"
          echo "ü™™ File ID: $FILE_ID"
          echo "üîó Web View Link: $WEBLINK"
