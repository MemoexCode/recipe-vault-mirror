name: Upload Markdown Snapshot to Google Drive (Direct API)

on:
  workflow_dispatch:
  push:
    branches:
      - main

jobs:
  snapshot:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Create Markdown Snapshot
        run: |
          SNAPSHOT="recipe-vault_FULLCODE_$(date +'%Y-%m-%d_%H-%M-%S').md"
          echo "# üì¶ Recipe Vault ‚Äì Full Source Snapshot" > "$SNAPSHOT"
          echo "" >> "$SNAPSHOT"
          echo "**Timestamp:** $(date)" >> "$SNAPSHOT"
          echo "**Repository:** $GITHUB_REPOSITORY" >> "$SNAPSHOT"
          echo "" >> "$SNAPSHOT"

          echo "## üìÅ Repository Structure" >> "$SNAPSHOT"
          tree -a -I ".git|node_modules" >> "$SNAPSHOT" || echo "(tree not available)" >> "$SNAPSHOT"
          echo "" >> "$SNAPSHOT"

          echo "## üß© Complete File Contents" >> "$SNAPSHOT"
          echo "" >> "$SNAPSHOT"

          while IFS= read -r -d '' file; do
            [ "$file" = "./$SNAPSHOT" ] && continue
            echo -e "\n\n### File: \`$file\`\n\`\`\`\n" >> "$SNAPSHOT"
            cat "$file" >> "$SNAPSHOT"
            echo -e "\n\`\`\`" >> "$SNAPSHOT"
          done < <(find . -type f -not -path "./.git/*" -not -path "./node_modules/*" -print0)

          echo "SNAPSHOT=$SNAPSHOT" >> $GITHUB_ENV

      - name: Upload Snapshot to Google Drive
        env:
          GDRIVE_JSON: ${{ secrets.GDRIVE_SERVICE_KEY }}
          FOLDER_ID: ${{ secrets.GDRIVE_BASE44_FOLDER_ID }}
        run: |
          sudo apt-get update -y && sudo apt-get install -y jq curl
          echo "$GDRIVE_JSON" > sa.json

          echo "üîê Getting access token..."
          ACCESS_TOKEN=$(curl -s -X POST \
            -H "Content-Type: application/json" \
            -d @<(jq -n --argjson sa "$(cat sa.json)" '
              {
                "grant_type": "urn:ietf:params:oauth:grant-type:jwt-bearer",
                "assertion": (
                  $sa |
                  {
                    "iss": .client_email,
                    "scope": "https://www.googleapis.com/auth/drive.file",
                    "aud": "https://oauth2.googleapis.com/token",
                    "exp": (now + 3600 | floor),
                    "iat": now | floor
                  } | @json
                )
              }') \
            "https://oauth2.googleapis.com/token" | jq -r '.access_token')

          if [ -z "$ACCESS_TOKEN" ] || [ "$ACCESS_TOKEN" = "null" ]; then
            echo "‚ùå Failed to obtain access token."
            exit 1
          fi

          echo "üì§ Uploading file: $SNAPSHOT ..."
          UPLOAD_RESULT=$(curl -s -X POST \
            -H "Authorization: Bearer $ACCESS_TOKEN" \
            -F "metadata={name : '$SNAPSHOT', parents : ['$FOLDER_ID']};type=application/json;charset=UTF-8" \
            -F "file=@$SNAPSHOT;type=text/markdown" \
            "https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart")

          FILE_ID=$(echo "$UPLOAD_RESULT" | jq -r '.id')

          if [ -z "$FILE_ID" ] || [ "$FILE_ID" = "null" ]; then
            echo "‚ùå Upload failed:"
            echo "$UPLOAD_RESULT"
            exit 1
          fi

          echo "‚úÖ Upload successful!"
          echo "ü™™ File ID: $FILE_ID"

          echo "üåê Retrieving webViewLink..."
          FILE_INFO=$(curl -s -X GET \
            -H "Authorization: Bearer $ACCESS_TOKEN" \
            "https://www.googleapis.com/drive/v3/files/$FILE_ID?fields=webViewLink,name")

          WEBLINK=$(echo "$FILE_INFO" | jq -r '.webViewLink')
          echo "‚úÖ Web View Link: $WEBLINK"
