name: Upload Markdown Snapshot to Google Drive (Non-Interactive)

on:
  workflow_dispatch:
  push:
    branches:
      - main

jobs:
  snapshot:
    runs-on: ubuntu-latest

    steps:
      # 1ï¸âƒ£ Repository auschecken
      - name: Checkout Repository
        uses: actions/checkout@v4

      # 2ï¸âƒ£ Markdown Snapshot generieren
      - name: Create Markdown Snapshot
        run: |
          SNAPSHOT="recipe-vault_FULLCODE_$(date +'%Y-%m-%d_%H-%M-%S').md"
          echo "# ğŸ“¦ Recipe Vault â€“ Full Source Snapshot" > "$SNAPSHOT"
          echo "" >> "$SNAPSHOT"
          echo "**Timestamp:** $(date)" >> "$SNAPSHOT"
          echo "**Repository:** $GITHUB_REPOSITORY" >> "$SNAPSHOT"
          echo "" >> "$SNAPSHOT"

          echo "## ğŸ“ Repository Structure" >> "$SNAPSHOT"
          tree -a -I ".git|node_modules" >> "$SNAPSHOT" || echo "(tree not available)" >> "$SNAPSHOT"
          echo "" >> "$SNAPSHOT"

          echo "## ğŸ§© Complete File Contents" >> "$SNAPSHOT"
          echo "" >> "$SNAPSHOT"

          while IFS= read -r -d '' file; do
            [ "$file" = "./$SNAPSHOT" ] && continue
            echo -e "\n\n### File: \`$file\`\n\`\`\`\n" >> "$SNAPSHOT"
            cat "$file" >> "$SNAPSHOT"
            echo -e "\n\`\`\`" >> "$SNAPSHOT"
          done < <(find . -type f -not -path "./.git/*" -not -path "./node_modules/*" -print0)

          echo "SNAPSHOT=$SNAPSHOT" >> $GITHUB_ENV

      # 3ï¸âƒ£ Snapshot zu Google Drive hochladen
      - name: Upload Snapshot to Google Drive
        env:
          GDRIVE_JSON: ${{ secrets.GDRIVE_SERVICE_KEY }}
          FOLDER_ID: ${{ secrets.GDRIVE_BASE44_FOLDER_ID }}
        run: |
          echo "ğŸ“¦ Installing dependencies..."
          sudo apt-get update -y && sudo apt-get install -y jq curl openssl

          echo "$GDRIVE_JSON" > sa.json

          echo "ğŸ” Generating access token..."
          ACCESS_TOKEN=$(curl -s -X POST \
            -H "Content-Type: application/x-www-form-urlencoded" \
            -d "grant_type=urn:ietf:params:oauth:grant-type:jwt-bearer" \
            -d "assertion=$(openssl base64 -A <<< $(jq -nc --argjson key "$(cat sa.json)" '
              def base64url(x): @base64 | gsub("\\+"; "-") | gsub("/"; "_") | gsub("=+$"; "");
              def sign(data; key):
                ("-----BEGIN PRIVATE KEY-----\n" + ($key.private_key | gsub("(.{64})"; "\1\n")) + "\n-----END PRIVATE KEY-----\n")
                | @base64;

              $header = {"alg": "RS256", "typ": "JWT"};
              $claimset = {
                iss: $key.client_email,
                scope: "https://www.googleapis.com/auth/drive.file https://www.googleapis.com/auth/drive",
                aud: "https://oauth2.googleapis.com/token",
                exp: (now + 3600 | floor),
                iat: (now | floor)
              };
              ($header | @json | @base64 | gsub("\\+"; "-") | gsub("/"; "_") | gsub("=+$"; "")) + "." +
              ($claimset | @json | @base64 | gsub("\\+"; "-") | gsub("/"; "_") | gsub("=+$"; ""))')')" \
            "https://oauth2.googleapis.com/token" | jq -r '.access_token')

          if [ -z "$ACCESS_TOKEN" ] || [ "$ACCESS_TOKEN" = "null" ]; then
            echo "âŒ Failed to obtain access token."
            exit 1
          fi

          echo "ğŸ“¤ Uploading file to Google Drive..."
          UPLOAD_RESULT=$(curl -s -X POST \
            -H "Authorization: Bearer $ACCESS_TOKEN" \
            -F "metadata={name : '$SNAPSHOT', parents : ['$FOLDER_ID']};type=application/json;charset=UTF-8" \
            -F "file=@$SNAPSHOT;type=text/markdown" \
            "https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart")

          FILE_ID=$(echo "$UPLOAD_RESULT" | jq -r '.id')
          if [ -z "$FILE_ID" ] || [ "$FILE_ID" = "null" ]; then
            echo "âŒ Upload failed!"
            echo "$UPLOAD_RESULT"
            exit 1
          fi

          echo "âœ… Upload successful! File ID: $FILE_ID"

          echo "ğŸŒ Retrieving webViewLink..."
          FILE_INFO=$(curl -s -X GET \
            -H "Authorization: Bearer $ACCESS_TOKEN" \
            "https://www.googleapis.com/drive/v3/files/$FILE_ID?fields=webViewLink,name")

          WEBLINK=$(echo "$FILE_INFO" | jq -r '.webViewLink')

          echo "âœ… Upload finished!"
          echo "ğŸªª File ID: $FILE_ID"
          echo "ğŸ”— Web View Link: $WEBLINK"
