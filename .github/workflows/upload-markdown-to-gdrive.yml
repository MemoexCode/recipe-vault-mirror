name: Upload Snapshot to Google Drive (Validated)

on:
  workflow_dispatch:

jobs:
  snapshot:
    runs-on: ubuntu-latest
    steps:
      - name: üßæ Checkout repository
        uses: actions/checkout@v4

      - name: üß© Create FULL Markdown Snapshot
        run: |
          SNAPSHOT="recipe-vault_FULLCODE_$(date '+%Y-%m-%d_%H-%M-%S').md"
          echo "Creating $SNAPSHOT ..."
          git log -1 --format=%H > "$SNAPSHOT"
          echo "Snapshot created: $SNAPSHOT"

      - name: üîê Decode Base64 Google Service Key
        run: |
          echo "Decoding Base64 service account key..."
          echo "${{ secrets.GDRIVE_SERVICE_KEY }}" | base64 --decode > /tmp/sa.json || {
            echo "::error::Base64 decode failed. Check if your secret is correctly encoded."
            exit 1
          }

      - name: ‚úÖ Validate JSON Syntax
        run: |
          sudo apt-get update -y
          sudo apt-get install -y jq
          if ! jq empty /tmp/sa.json >/dev/null 2>&1; then
            echo "::error::Invalid JSON in decoded service key!"
            exit 1
          fi
          echo "‚úÖ JSON structure valid."

      - name: üß† Authenticate Google Service Account
        run: |
          echo "üîë Authenticating with Google Cloud..."
          sudo apt-get install -y google-cloud-cli
          gcloud auth activate-service-account --key-file=/tmp/sa.json || {
            echo "::error::Authentication failed ‚Äî check your service key and IAM roles."
            exit 1
          }
          echo "‚úÖ Authenticated successfully."

      - name: üìÅ Check Drive Folder Access
        run: |
          echo "Checking Google Drive access..."
          gcloud auth print-access-token > /tmp/token.txt
          ACCESS=$(curl -s -o /dev/null -w "%{http_code}" \
            -H "Authorization: Bearer $(cat /tmp/token.txt)" \
            "https://www.googleapis.com/drive/v3/files")
          if [ "$ACCESS" -ne 200 ]; then
            echo "::error::Google Drive API not accessible (HTTP $ACCESS)"
            exit 1
          fi
          echo "‚úÖ Drive API access confirmed."

      - name: ‚òÅÔ∏è Upload Snapshot to Google Drive
        run: |
          SNAPSHOT=$(ls -t recipe-vault_FULLCODE_*.md | head -n 1)
          echo "üì§ Uploading $SNAPSHOT to Google Drive..."

          FILE_ID=$(curl -s -X POST \
            -H "Authorization: Bearer $(gcloud auth print-access-token)" \
            -F "metadata={name : '$SNAPSHOT', mimeType : 'text/markdown'};type=application/json;charset=UTF-8" \
            -F "file=@$SNAPSHOT;type=text/markdown" \
            "https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart" \
            | jq -r '.id')

          if [ "$FILE_ID" = "null" ] || [ -z "$FILE_ID" ]; then
            echo "::error::Upload failed ‚Äî check permissions or folder sharing."
            exit 1
          fi

          echo "‚úÖ Upload successful. File ID: $FILE_ID"

      - name: üßπ Cleanup
        if: always()
        run: |
          rm -f /tmp/sa.json /tmp/token.txt
          echo "Temporary files cleaned up."
