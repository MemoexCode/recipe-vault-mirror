name: Upload Markdown Snapshot to Google Drive (Direct API)

on:
  workflow_dispatch:
  push:
    branches:
      - main

jobs:
  snapshot:
    runs-on: ubuntu-latest

    steps:
      # 1Ô∏è‚É£ Repository auschecken
      - name: Checkout Repository
        uses: actions/checkout@v4

      # 2Ô∏è‚É£ Markdown-Datei mit vollst√§ndigem Projektcode erzeugen
      - name: Create FULL Markdown Snapshot
        run: |
          SNAPSHOT="recipe-vault_FULLCODE_$(date +'%Y-%m-%d_%H-%M-%S').md"
          echo "# üì¶ Recipe Vault ‚Äì Full Source Snapshot" > "$SNAPSHOT"
          echo "" >> "$SNAPSHOT"
          echo "**Timestamp:** $(date)" >> "$SNAPSHOT"
          echo "**Repository:** $GITHUB_REPOSITORY" >> "$SNAPSHOT"
          echo "" >> "$SNAPSHOT"
          echo "## üìÅ Repository Structure" >> "$SNAPSHOT"
          tree -a -I ".git|node_modules" >> "$SNAPSHOT" || echo "(tree not available)" >> "$SNAPSHOT"
          echo "" >> "$SNAPSHOT"
          echo "## üß© Complete File Contents" >> "$SNAPSHOT"
          while IFS= read -r -d '' file; do
            echo -e "\n\n### File: \`$file\`\n\`\`\`\n" >> "$SNAPSHOT"
            cat "$file" >> "$SNAPSHOT"
            echo -e "\n\`\`\`" >> "$SNAPSHOT"
          done < <(find . -type f -not -path "./.git/*" -not -path "./node_modules/*" -print0)
          echo "SNAPSHOT=$SNAPSHOT" >> $GITHUB_ENV

      # 3Ô∏è‚É£ Google Drive Upload via API
      - name: Upload Snapshot to Google Drive
        env:
          GDRIVE_JSON: ${{ secrets.GDRIVE_SERVICE_KEY }}
          FOLDER_ID: ${{ secrets.GDRIVE_BASE44_FOLDER_ID }}
        run: |
          sudo apt-get update -y
          sudo apt-get install -y jq curl

          echo "$GDRIVE_JSON" > sa.json
          ACCESS_TOKEN=$(curl -s -X POST \
            -H "Content-Type: application/json" \
            -d "$(jq -n --arg type "service_account" --argjson sa "$(cat sa.json)" '
              {
                "grant_type": "urn:ietf:params:oauth:grant-type:jwt-bearer",
                "assertion": (
                  $sa |
                  {
                    "iss": .client_email,
                    "scope": "https://www.googleapis.com/auth/drive.file",
                    "aud": "https://oauth2.googleapis.com/token",
                    "exp": (now + 3600 | floor),
                    "iat": now | floor
                  } | @json
                )
              }')" \
            "https://oauth2.googleapis.com/token" | jq -r '.access_token')

          if [ -z "$ACCESS_TOKEN" ] || [ "$ACCESS_TOKEN" = "null" ]; then
            echo "‚ùå Failed to obtain access token"
            exit 1
          fi

          echo "üì§ Uploading $SNAPSHOT to Google Drive..."
          RESULT=$(curl -s -X POST \
            -H "Authorization: Bearer $ACCESS_TOKEN" \
            -F "metadata={name : '$SNAPSHOT', parents : ['$FOLDER_ID']};type=application/json;charset=UTF-8" \
            -F "file=@$SNAPSHOT;type=text/markdown" \
            "https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart")

          echo ""
          echo "üìÑ Google Drive Response:"
          echo "$RESULT" | jq || echo "$RESULT"
