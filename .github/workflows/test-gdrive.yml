name: Test Google Drive Connection (Direct API)

on:
  workflow_dispatch:

jobs:
  upload:
    runs-on: ubuntu-latest

    steps:
      - name: Create test file
        run: |
          echo "âœ… Google Drive direct API test successful!" > gdrive_test.txt
          echo "Timestamp: $(date)" >> gdrive_test.txt
          echo "Repository: $GITHUB_REPOSITORY" >> gdrive_test.txt

      - name: Prepare credentials
        run: |
          echo '${{ secrets.GDRIVE_SERVICE_KEY }}' > service_account.json
          apt-get update >/dev/null
          apt-get install -y jq curl >/dev/null

      - name: Get access token
        id: auth
        run: |
          TOKEN=$(curl -s --request POST \
            --header "Content-Type: application/json" \
            --data @"<(
              jq -n --arg type "service_account" \
                 --argjson key "$(jq . service_account.json)" '
                 $key | {
                   "iss": .client_email,
                   "scope": "https://www.googleapis.com/auth/drive.file",
                   "aud": "https://oauth2.googleapis.com/token",
                   "exp": (now + 3600 | floor),
                   "iat": now | floor
                 }' | \
                 openssl dgst -sha256 -sign <(jq -r .private_key service_account.json) | openssl base64 -A
             )" \
            "https://oauth2.googleapis.com/token" | jq -r '.access_token')

          echo "access_token=$TOKEN" >> $GITHUB_ENV

      - name: Upload file to Google Drive
        run: |
          FOLDER_ID="${{ secrets.GDRIVE_BASE44_FOLDER_ID }}"
          FILE_NAME="gdrive_test_$(date +'%Y-%m-%d_%H-%M-%S').txt"

          echo "Uploading $FILE_NAME to Google Drive folder $FOLDER_ID..."
          RESULT=$(curl -s -X POST \
            -H "Authorization: Bearer $access_token" \
            -F "metadata={name : '$FILE_NAME', parents : ['$FOLDER_ID']};type=application/json;charset=UTF-8" \
            -F "file=@gdrive_test.txt;type=text/plain" \
            "https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart")

          echo "$RESULT" | jq
