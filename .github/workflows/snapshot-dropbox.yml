name: Create and Upload Snapshots to Dropbox

on:
  push:
    branches:
      - main

jobs:
  snapshot:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Set variables
        run: |
          echo "commit_sha=$(git rev-parse --short HEAD)" >> $GITHUB_ENV
          echo "timestamp=$(date +'%Y-%m-%d_%H-%M-%S')" >> $GITHUB_ENV
          # Output-Verzeichnis auÃŸerhalb des Repos
          echo "out_dir=$RUNNER_TEMP/snapshots" >> $GITHUB_ENV
          mkdir -p "$RUNNER_TEMP/snapshots"

      - name: Create FULL Snapshot (.tar.gz) into temp dir
        run: |
          SNAPSHOT_FULL="recipe-vault_FULL_${{ env.timestamp }}_${{ env.commit_sha }}.tar.gz"
          SNAPSHOT_FULL_PATH="${{ env.out_dir }}/${SNAPSHOT_FULL}"
          # Archivieren, aber Output-Ordner, .git und node_modules ausschlieÃŸen
          tar \
            --exclude="${{ env.out_dir }}" \
            --exclude='./.git' \
            --exclude='./node_modules' \
            -czf "$SNAPSHOT_FULL_PATH" .
          echo "snapshot_full=$SNAPSHOT_FULL" >> $GITHUB_ENV
          echo "snapshot_full_path=$SNAPSHOT_FULL_PATH" >> $GITHUB_ENV

      - name: Create DIFF Snapshot (.patch) into temp dir (robust for first commit)
        run: |
          SNAPSHOT_DIFF="recipe-vault_DIFF_${{ env.timestamp }}_${{ env.commit_sha }}.patch"
          SNAPSHOT_DIFF_PATH="${{ env.out_dir }}/${SNAPSHOT_DIFF}"
          (git diff HEAD~1 HEAD > "$SNAPSHOT_DIFF_PATH" || echo "No previous commit - initial commit detected." > "$SNAPSHOT_DIFF_PATH")
          echo "snapshot_diff=$SNAPSHOT_DIFF" >> $GITHUB_ENV
          echo "snapshot_diff_path=$SNAPSHOT_DIFF_PATH" >> $GITHUB_ENV

      - name: Upload FULL Snapshot to Dropbox
        env:
          DROPBOX_TOKEN: ${{ secrets.DROPBOX_TOKEN }}
        run: |
          echo "ðŸ“¤ Uploading FULL snapshot..."
          curl -s -X POST https://content.dropboxapi.com/2/files/upload \
            --header "Authorization: Bearer $DROPBOX_TOKEN" \
            --header "Dropbox-API-Arg: {\"path\": \"/Base44_RecipeVault/06_Dokumentation_Versioning/${{ env.snapshot_full }}\",\"mode\": \"add\",\"autorename\": true}" \
            --header "Content-Type: application/octet-stream" \
            --data-binary @"${{ env.snapshot_full_path }}" \
          && echo "âœ… FULL snapshot uploaded."

      - name: Upload DIFF Snapshot to Dropbox
        env:
          DROPBOX_TOKEN: ${{ secrets.DROPBOX_TOKEN }}
        run: |
          echo "ðŸ“¤ Uploading DIFF snapshot..."
          curl -s -X POST https://content.dropboxapi.com/2/files/upload \
            --header "Authorization: Bearer $DROPBOX_TOKEN" \
            --header "Dropbox-API-Arg: {\"path\": \"/Base44_RecipeVault/06_Dokumentation_Versioning/${{ env.snapshot_diff }}\",\"mode\": \"add\",\"autorename\": true}" \
            --header "Content-Type: application/octet-stream" \
            --data-binary @"${{ env.snapshot_diff_path }}" \
          && echo "âœ… DIFF snapshot uploaded."

      - name: Confirm upload
        run: |
          echo "âœ… Uploaded to /Base44_RecipeVault/06_Dokumentation_Versioning/"
          echo " - ${{ env.snapshot_full }}"
          echo " - ${{ env.snapshot_diff }}"
