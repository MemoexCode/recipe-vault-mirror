name: Create and Upload Snapshots to Dropbox

# ğŸ“¦ AuslÃ¶ser: bei jedem Push auf den main-Branch
on:
  push:
    branches:
      - main

jobs:
  snapshot:
    runs-on: ubuntu-latest

    steps:
      # ğŸ”¹ Repository auschecken
      - name: Checkout Repository
        uses: actions/checkout@v4

      # ğŸ”¹ Umgebungsvariablen (Datum + Commit-Hash)
      - name: Set variables
        id: vars
        run: |
          echo "commit_sha=$(git rev-parse --short HEAD)" >> $GITHUB_ENV
          echo "timestamp=$(date +'%Y-%m-%d_%H-%M-%S')" >> $GITHUB_ENV

      # ğŸ”¹ VollstÃ¤ndigen Snapshot erzeugen (.tar.gz)
      - name: Create FULL Snapshot (.tar.gz)
        run: |
          SNAPSHOT_FULL="recipe-vault_FULL_${{ env.timestamp }}_${{ env.commit_sha }}.tar.gz"
          tar --exclude='./.git' --exclude='./node_modules' -czf "$SNAPSHOT_FULL" .
          echo "snapshot_full=$SNAPSHOT_FULL" >> $GITHUB_ENV

      # ğŸ”¹ Ã„nderungs-Snapshot erzeugen (.patch)
      - name: Create DIFF Snapshot (.patch)
        run: |
          SNAPSHOT_DIFF="recipe-vault_DIFF_${{ env.timestamp }}_${{ env.commit_sha }}.patch"
          git diff HEAD~1 HEAD > "$SNAPSHOT_DIFF" || echo "No previous commit"
          echo "snapshot_diff=$SNAPSHOT_DIFF" >> $GITHUB_ENV

      # ğŸ”¹ Snapshots in Dropbox hochladen
      - name: Upload Snapshots to Dropbox
        uses: tj-actions/dropbox-upload@v3
        with:
          # ğŸ”‘ Token aus GitHub Secrets (muss zuvor hinterlegt sein)
          dropbox_access_token: ${{ secrets.DROPBOX_TOKEN }}

          # ğŸ“ Lokale Dateien, die hochgeladen werden sollen
          src: |
            ${{ env.snapshot_full }}
            ${{ env.snapshot_diff }}

          # ğŸŒ Zielordner in Dropbox
          dest: /AOp1EmihZE0GDFwgjcBh4gE/

      # ğŸ”¹ Optional: Upload-Ergebnis anzeigen
      - name: Confirm upload
        run: |
          echo "Snapshots successfully created and uploaded:"
          echo " - ${{ env.snapshot_full }}"
          echo " - ${{ env.snapshot_diff }}"
