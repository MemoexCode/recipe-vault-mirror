name: Create and Upload Complete Markdown Snapshot to Dropbox

on:
  push:
    branches:
      - main

jobs:
  snapshot:
    runs-on: ubuntu-latest

    steps:
      # 1Ô∏è‚É£ Repository auschecken
      - name: Checkout Repository
        uses: actions/checkout@v4

      # 2Ô∏è‚É£ Variablen setzen
      - name: Set variables
        run: |
          echo "commit_sha=$(git rev-parse --short HEAD)" >> $GITHUB_ENV
          echo "timestamp=$(date +'%Y-%m-%d_%H-%M-%S')" >> $GITHUB_ENV
          echo "out_dir=$RUNNER_TEMP/snapshots" >> $GITHUB_ENV
          mkdir -p "$RUNNER_TEMP/snapshots"

      # 3Ô∏è‚É£ Markdown-Datei erzeugen (mit gesamtem Codeinhalt)
      - name: Create FULL Markdown Snapshot
        run: |
          SNAPSHOT_FILE="recipe-vault_FULLCODE_${{ env.timestamp }}_${{ env.commit_sha }}.md"
          SNAPSHOT_PATH="${{ env.out_dir }}/${SNAPSHOT_FILE}"

          echo "# üì¶ Recipe Vault ‚Äì Full Source Snapshot" > "$SNAPSHOT_PATH"
          echo "" >> "$SNAPSHOT_PATH"
          echo "**Timestamp:** ${{ env.timestamp }}" >> "$SNAPSHOT_PATH"
          echo "**Commit:** ${{ env.commit_sha }}" >> "$SNAPSHOT_PATH"
          echo "" >> "$SNAPSHOT_PATH"

          echo "## üìÅ Repository Structure" >> "$SNAPSHOT_PATH"
          tree -I ".git|node_modules" -a >> "$SNAPSHOT_PATH" || echo "(tree command not available)" >> "$SNAPSHOT_PATH"
          echo "" >> "$SNAPSHOT_PATH"

          echo "## üß© Complete File Contents" >> "$SNAPSHOT_PATH"
          echo "" >> "$SNAPSHOT_PATH"

          # Jede Datei vollst√§ndig lesen und in Markdown-Codeblock einf√ºgen
          while IFS= read -r -d '' file; do
            echo -e "\n\n### File: \`$file\`\n\`\`\`\n" >> "$SNAPSHOT_PATH"
            cat "$file" >> "$SNAPSHOT_PATH"
            echo -e "\n\`\`\`" >> "$SNAPSHOT_PATH"
          done < <(find . -type f -not -path "./.git/*" -not -path "./node_modules/*" -print0)

          echo "snapshot_file=$SNAPSHOT_FILE" >> $GITHUB_ENV
          echo "snapshot_path=$SNAPSHOT_PATH" >> $GITHUB_ENV

      # 4Ô∏è‚É£ Upload zu Dropbox
      - name: Upload Markdown Snapshot to Dropbox
        env:
          DROPBOX_TOKEN: ${{ secrets.DROPBOX_TOKEN }}
        run: |
          echo "üì§ Uploading FULLCODE Markdown snapshot..."
          curl -s -X POST https://content.dropboxapi.com/2/files/upload \
            --header "Authorization: Bearer $DROPBOX_TOKEN" \
            --header "Dropbox-API-Arg: {\"path\": \"/Base44_RecipeVault/06_Dokumentation_Versioning/${{ env.snapshot_file }}\",\"mode\": \"add\",\"autorename\": true}" \
            --header "Content-Type: application/octet-stream" \
            --data-binary @"${{ env.snapshot_path }}" \
          && echo "‚úÖ Markdown snapshot uploaded successfully."

      # 5Ô∏è‚É£ Abschlussmeldung
      - name: Confirm upload
        run: |
          echo "‚úÖ Snapshot created and uploaded:"
          echo "üìÅ /Base44_RecipeVault/06_Dokumentation_Versioning/${{ env.snapshot_file }}"
