name: Export Repo Tree and Update Introspection Index

on:
  push:
    branches: [ "main" ]
  schedule:
    - cron: "0 2 * * *"   # täglich um 02:00 UTC
  workflow_dispatch:

jobs:
  export:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          persist-credentials: false
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.x"

      - name: Install GitHub CLI
        run: sudo apt-get install -y gh jq

      - name: Generate structure introspection files
        run: |
          mkdir -p _introspection
          echo "Generating repo_tree.json ..."
          git ls-tree -r --long HEAD | awk '{
            if (NR==1) printf("[\n");
            printf("{\"path\":\"%s\",\"sha\":\"%s\",\"size\":%s}", $4, $3, $5);
            if (NR!=0) printf(",\n");
          } END {print "]"}' > _introspection/repo_tree.json

          echo "# Repo Index (HEAD)" > _introspection/repo_index.md
          git ls-tree -r --name-only HEAD >> _introspection/repo_index.md

      - name: Generate full-fidelity snapshot
        run: |
          mkdir -p _introspection
          SNAPSHOT="_introspection/repo_snapshot_$(date -u +'%Y-%m-%dT%H-%M-%SZ')_$(git rev-parse --short HEAD).jsonl"
          echo "Creating $SNAPSHOT ..."
          git ls-files | while read file; do
            if [ -f "$file" ]; then
              commit=$(git log -n 1 --pretty=format:%h -- "$file")
              timestamp=$(git log -n 1 --pretty=format:%cI -- "$file")
              content=$(base64 "$file" | tr -d '\n')
              printf '{"path":"%s","commit":"%s","timestamp":"%s","content_b64":"%s"}\n' "$file" "$commit" "$timestamp" "$content" >> "$SNAPSHOT"
            fi
          done
          echo "✅ Snapshot generated: $SNAPSHOT"

      - name: Generate introspection index markdown
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "Updating _index_files.md ..."
          gh api "repos/${{ github.repository }}/contents/_introspection" \
            --jq '.[] | .name' > tmp_list.txt

          echo "# 🔍 Repository Introspection Snapshot" > _introspection/_index_files.md
          echo "*Erstellt am $(date -u +"%Y-%m-%d %H:%M:%S UTC")*" >> _introspection/_index_files.md
          echo "" >> _introspection/_index_files.md
          echo "| Datei | Commit | Timestamp | Direktlink |" >> _introspection/_index_files.md
          echo "|:------|:--------|:-----------|:------------|" >> _introspection/_index_files.md

          while read name; do
            if [[ "$name" == repo_snapshot_* ]]; then
              commit=$(echo "$name" | sed -E 's/.*commit-([0-9a-f]+)\.jsonl/\1/')
              timestamp=$(echo "$name" | grep -oP '\d{4}-\d{2}-\d{2}T\d{2}-\d{2}-\d{2}Z')
              echo "| \`$name\` | \`$commit\` | $timestamp | [Link](https://raw.githubusercontent.com/${{ github.repository }}/main/_introspection/$name) |" >> _introspection/_index_files.md
            else
              echo "| \`$name\` | – | – | [Link](https://raw.githubusercontent.com/${{ github.repository }}/main/_introspection/$name) |" >> _introspection/_index_files.md
            fi
          done < tmp_list.txt

          rm tmp_list.txt
          echo "✅ _index_files.md aktualisiert"

      - name: Commit & push if changed
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add _introspection
          git diff --quiet && echo "No changes" || (git commit -m "chore(introspection): auto-update with commit and timestamp" && git push)
